<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu相簿企業版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        [v-cloak] { display: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        /* 畫筆游標 */
        .cursor-pen { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>') 0 24, crosshair; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased">

<div id="app" v-cloak>
    <div v-if="loading" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-4"></div>
        <p class="text-gray-500 animate-pulse">正在從雲端讀取相簿櫃...</p>
    </div>

    <div v-else-if="error" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-50 p-4 text-center">
        <i class="fa-solid fa-triangle-exclamation text-6xl text-red-400 mb-4"></i>
        <h2 class="text-2xl font-bold text-gray-700 mb-2">無法讀取相簿</h2>
        <p class="text-gray-500 max-w-md">{{ error }}</p>
        <p class="text-sm text-gray-400 mt-4">ID: {{ deploymentId }}</p>
    </div>

    <div v-else class="min-h-screen flex flex-col">
        
        <nav class="bg-white shadow sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center cursor-pointer" @click="goHome">
                        <i class="fa-solid fa-camera-retro text-blue-600 text-2xl mr-2"></i>
                        <span class="font-bold text-xl tracking-tight">{{ sysInfo.title || 'Qu Album' }}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                         <span class="text-xs text-gray-400 hidden sm:inline">Last update: {{ formatDate(sysInfo.updatedAt) }}</span>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
            
            <div v-if="viewMode === 'bookshelf'" class="animate-fade-in">
                <h2 class="text-2xl font-bold mb-6 border-l-4 border-blue-500 pl-3">相簿列表</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div v-for="album in albums" :key="album.id" 
                         @click="openAlbum(album)"
                         class="group bg-white rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 cursor-pointer overflow-hidden border border-gray-100 transform hover:-translate-y-1">
                        <div class="aspect-w-4 aspect-h-3 bg-gray-200 relative overflow-hidden">
                            <img :src="album.cover || 'https://via.placeholder.com/400x300?text=No+Image'" 
                                 class="object-cover w-full h-full group-hover:scale-110 transition-transform duration-700" 
                                 loading="lazy">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all"></div>
                            <div v-if="album.pwd" class="absolute top-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded-full text-xs">
                                <i class="fa-solid fa-lock"></i>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-lg text-gray-800 truncate group-hover:text-blue-600 transition">{{ album.name }}</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-sm text-gray-500"><i class="fa-regular fa-images mr-1"></i> {{ album.count }} 張</span>
                                <i class="fa-solid fa-arrow-right text-gray-300 group-hover:text-blue-500 transition transform group-hover:translate-x-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else-if="viewMode === 'gallery'" class="animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <button @click="goHome" class="text-gray-500 hover:text-blue-600 transition flex items-center">
                        <i class="fa-solid fa-arrow-left mr-2"></i> 返回列表
                    </button>
                    <div class="flex space-x-2">
                         <button @click="downloadAlbum" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-full text-sm transition flex items-center shadow-lg">
                            <i class="fa-solid fa-cloud-arrow-down mr-2"></i> 打包下載
                        </button>
                    </div>
                </div>

                <h2 class="text-3xl font-bold mb-2">{{ currentAlbum.name }}</h2>
                <p class="text-gray-500 mb-6 text-sm">共 {{ currentAlbum.count }} 張相片</p>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-4">
                    <div v-for="(photo, index) in currentAlbum.photos" :key="photo.id"
                         @click="openLightbox(index)"
                         class="relative aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer group">
                        <img :src="photo.c" loading="lazy" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all flex items-center justify-center">
                            <i class="fa-solid fa-magnifying-glass-plus text-white opacity-0 group-hover:opacity-100 transform scale-50 group-hover:scale-100 transition duration-300 text-2xl"></i>
                        </div>
                        <span v-if="photo.t === 'v'" class="absolute top-2 right-2 text-white drop-shadow-md"><i class="fa-solid fa-video"></i></span>
                    </div>
                </div>
            </div>

        </main>

        <footer class="bg-white border-t py-6 text-center text-sm text-gray-400">
            &copy; 2024 Qu Album Enterprise. Powered by Google & Cloudflare.
        </footer>
    </div>

    <div v-if="showLightbox" class="fixed inset-0 z-[100] bg-black bg-opacity-95 flex flex-col" @keydown.esc="closeLightbox" tabindex="0">
        
        <div class="flex justify-between items-center p-4 text-white bg-gradient-to-b from-black/80 to-transparent z-50">
            <div class="flex items-center space-x-4">
                <span class="text-lg font-bold">{{ currentPhotoIndex + 1 }} / {{ currentAlbum.photos.length }}</span>
                <button @click="toggleDrawing" :class="isDrawingMode ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300'" class="px-3 py-1.5 rounded-full text-sm transition border border-gray-600 flex items-center">
                    <i class="fa-solid fa-pen-nib mr-2"></i> {{ isDrawingMode ? '畫筆開啟' : '畫筆模式' }}
                </button>
                <div v-if="isDrawingMode" class="flex space-x-2 animate-fade-in">
                    <button @click="penColor = '#ef4444'" class="w-6 h-6 rounded-full bg-red-500 border-2" :class="penColor==='#ef4444'?'border-white':'border-transparent'"></button>
                    <button @click="penColor = '#eab308'" class="w-6 h-6 rounded-full bg-yellow-500 border-2" :class="penColor==='#eab308'?'border-white':'border-transparent'"></button>
                    <button @click="clearCanvas" class="text-xs bg-gray-800 px-2 py-1 rounded ml-2 hover:bg-gray-700">清除</button>
                </div>
            </div>
            <button @click="closeLightbox" class="w-10 h-10 rounded-full bg-gray-800 hover:bg-red-500 transition flex items-center justify-center">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>

        <div class="flex-1 relative flex items-center justify-center overflow-hidden bg-black select-none">
            <canvas ref="drawCanvas" v-show="isDrawingMode"
                class="absolute inset-0 z-20 cursor-pen touch-none"
                @mousedown="startDraw" @mousemove="drawing" @mouseup="stopDraw" @mouseout="stopDraw"
                @touchstart="startDraw" @touchmove="drawing" @touchend="stopDraw">
            </canvas>

            <img v-if="currentPhoto.t === 'i'" :src="currentPhoto.u" class="max-h-full max-w-full object-contain z-10 select-none pointer-events-none">
            <video v-else :src="getProxyUrl(currentPhoto.u)" controls autoplay class="max-h-full max-w-full z-10"></video>

            <button v-if="!isDrawingMode" @click="prevPhoto" class="absolute left-4 z-30 w-12 h-12 rounded-full bg-black/50 hover:bg-white/20 text-white flex items-center justify-center transition">
                <i class="fa-solid fa-chevron-left text-2xl"></i>
            </button>
            <button v-if="!isDrawingMode" @click="nextPhoto" class="absolute right-4 z-30 w-12 h-12 rounded-full bg-black/50 hover:bg-white/20 text-white flex items-center justify-center transition">
                <i class="fa-solid fa-chevron-right text-2xl"></i>
            </button>
        </div>

        <div v-if="!isDrawingMode" class="h-20 bg-black/90 flex items-center space-x-2 px-4 overflow-x-auto border-t border-gray-800 z-50">
            <div v-for="(p, idx) in currentAlbum.photos" :key="p.id" 
                 @click="changePhoto(idx)"
                 :class="{'ring-2 ring-blue-500 opacity-100': idx === currentPhotoIndex, 'opacity-50 hover:opacity-100': idx !== currentPhotoIndex}"
                 class="h-14 w-14 flex-shrink-0 cursor-pointer rounded overflow-hidden transition relative">
                <img :src="p.c" class="w-full h-full object-cover">
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // State
            const loading = ref(true);
            const error = ref(null);
            const deploymentId = ref('');
            const sysInfo = ref({});
            const albums = ref([]);
            
            const viewMode = ref('bookshelf'); // 'bookshelf' | 'gallery'
            const currentAlbum = ref(null);
            
            const showLightbox = ref(false);
            const currentPhotoIndex = ref(0);
            
            // Drawing State
            const isDrawingMode = ref(false);
            const penColor = ref('#ef4444');
            const drawCanvas = ref(null);
            const ctx = ref(null);
            const isPainting = ref(false);

            const currentPhoto = computed(() => {
                if (!currentAlbum.value) return {};
                return currentAlbum.value.photos[currentPhotoIndex.value];
            });

            // 初始化
            onMounted(async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const id = urlParams.get('id');
                
                if (!id) {
                    error.value = "網址無效：缺少 id 參數。請從 Google Sheet 取得正確連結。";
                    loading.value = false;
                    return;
                }
                
                deploymentId.value = id;
                await fetchData(id);
                
                // Keyboard Event
                window.addEventListener('keydown', (e) => {
                    if (!showLightbox.value) return;
                    if (e.key === 'ArrowRight') nextPhoto();
                    if (e.key === 'ArrowLeft') prevPhoto();
                });
            });

            // API Fetch
            const fetchData = async (id) => {
                try {
                    const res = await fetch(`/api/albums?id=${id}`);
                    if (!res.ok) throw new Error('相簿資料讀取失敗 (404 Not Found)');
                    const data = await res.json();
                    
                    if (data.error) throw new Error(data.error);

                    sysInfo.value = data.sys;
                    albums.value = data.albums;
                } catch (err) {
                    error.value = err.message;
                } finally {
                    loading.value = false;
                }
            };

            // Navigation
            const goHome = () => {
                viewMode.value = 'bookshelf';
                currentAlbum.value = null;
            };

            const openAlbum = (album) => {
                currentAlbum.value = album;
                viewMode.value = 'gallery';
                window.scrollTo(0, 0);
            };

            // Lightbox Logic
            const openLightbox = (index) => {
                currentPhotoIndex.value = index;
                showLightbox.value = true;
                isDrawingMode.value = false;
            };

            const closeLightbox = () => {
                showLightbox.value = false;
                clearCanvas();
            };

            const changePhoto = (index) => {
                currentPhotoIndex.value = index;
                clearCanvas();
            };

            const nextPhoto = () => {
                currentPhotoIndex.value = (currentPhotoIndex.value + 1) % currentAlbum.value.photos.length;
                clearCanvas();
            };

            const prevPhoto = () => {
                currentPhotoIndex.value = (currentPhotoIndex.value - 1 + currentAlbum.value.photos.length) % currentAlbum.value.photos.length;
                clearCanvas();
            };

            // Drawing Logic (Canvas)
            const toggleDrawing = async () => {
                isDrawingMode.value = !isDrawingMode.value;
                if (isDrawingMode.value) {
                    await nextTick();
                    initCanvas();
                }
            };

            const initCanvas = () => {
                const canvas = drawCanvas.value;
                if (!canvas) return;
                // 設定 Canvas 大小等於視窗大小 (Responsive)
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                ctx.value = canvas.getContext('2d');
                ctx.value.lineCap = 'round';
                ctx.value.lineJoin = 'round';
                ctx.value.lineWidth = 5;
            };

            const getPos = (e) => {
                if (e.touches && e.touches.length > 0) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            }

            const startDraw = (e) => {
                if (!isDrawingMode.value) return;
                isPainting.value = true;
                const { x, y } = getPos(e);
                ctx.value.strokeStyle = penColor.value;
                ctx.value.beginPath();
                ctx.value.moveTo(x, y);
            };

            const drawing = (e) => {
                if (!isPainting.value) return;
                e.preventDefault(); // 防止手機滑動
                const { x, y } = getPos(e);
                ctx.value.lineTo(x, y);
                ctx.value.stroke();
            };

            const stopDraw = () => {
                isPainting.value = false;
                if (ctx.value) ctx.value.closePath();
            };

            const clearCanvas = () => {
                if (ctx.value && drawCanvas.value) {
                    ctx.value.clearRect(0, 0, drawCanvas.value.width, drawCanvas.value.height);
                }
            };

            // Download Logic (Zip via Cloudflare Proxy)
            const downloadAlbum = async () => {
                const zip = new JSZip();
                const folderName = currentAlbum.value.name;
                const photos = currentAlbum.value.photos;
                
                // SweetAlert2 style toast (Vanilla JS implementation for simplicity)
                const btnText = document.querySelector('button i.fa-cloud-arrow-down').nextSibling;
                const originalText = btnText.textContent;
                btnText.textContent = ` 打包中 (0/${photos.length})...`;

                try {
                    const promises = photos.map(async (photo, i) => {
                        // 關鍵：使用 Cloudflare Proxy 繞過 CORS
                        // 原始 URL: https://lh3.googleusercontent.com/...
                        // Proxy URL: /api/proxy?url=...
                        const proxyUrl = `/api/proxy?url=${encodeURIComponent(photo.u)}`;
                        
                        try {
                            const response = await fetch(proxyUrl);
                            if (!response.ok) throw new Error('Network error');
                            const blob = await response.blob();
                            const ext = photo.t === 'v' ? 'mp4' : 'jpg';
                            zip.file(`${folderName}_${i + 1}.${ext}`, blob);
                            
                            // Update progress (Basic)
                            btnText.textContent = ` 打包中 (${i+1}/${photos.length})...`;
                        } catch (e) {
                            console.error('Failed to download:', photo.n);
                        }
                    });

                    await Promise.all(promises);
                    
                    btnText.textContent = " 壓縮中...";
                    const content = await zip.generateAsync({ type: "blob" });
                    saveAs(content, `${folderName}.zip`);
                    
                    btnText.textContent = originalText;
                    alert('下載開始！');

                } catch (e) {
                    console.error(e);
                    alert('下載失敗，請稍後再試。');
                    btnText.textContent = originalText;
                }
            };

            const getProxyUrl = (url) => {
                return `/api/proxy?url=${encodeURIComponent(url)}`;
            }

            const formatDate = (isoStr) => {
                if (!isoStr) return '';
                return new Date(isoStr).toLocaleString('zh-TW', { hour12: false });
            };

            return {
                loading, error, deploymentId, sysInfo, albums, viewMode, currentAlbum,
                showLightbox, currentPhotoIndex, currentPhoto,
                goHome, openAlbum, openLightbox, closeLightbox, changePhoto, nextPhoto, prevPhoto,
                isDrawingMode, penColor, drawCanvas, toggleDrawing, startDraw, drawing, stopDraw, clearCanvas,
                downloadAlbum, getProxyUrl, formatDate
            };
        }
    }).mount('#app');
</script>
</body>
</html>
